<!DOCTYPE html>
<html lang="mn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Электроникийн Хайлтын Систем</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f9;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      .search-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .search-container label {
        margin-right: 5px;
        font-weight: bold;
      }
      .search-container input,
      .search-container select,
      .search-container button {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      .search-container button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .search-container button:hover {
        background-color: #0056b3;
      }
      #results {
        margin-top: 20px;
      }
      .result-item {
        background-color: #fff;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .result-item h3 {
        margin: 0 0 10px 0;
        color: #007bff;
      }
      .result-item p {
        margin: 5px 0;
        color: #555;
      }
      .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }
      .pagination button {
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .pagination button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .pagination button:hover:not(:disabled) {
        background-color: #0056b3;
      }
      .analytics-container,
      .feedback-container {
        margin-top: 30px;
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .analytics-container h2,
      .feedback-container h2 {
        margin-top: 0;
        color: #333;
      }
      .feedback-container textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: vertical;
      }
      .feedback-container button {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .feedback-container button:hover {
        background-color: #218838;
      }
      .feedback-item {
        background-color: #f8f9fa;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
      }
      #suggestions {
        position: absolute;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      #suggestions div {
        padding: 8px;
        cursor: pointer;
      }
      #suggestions div:hover {
        background-color: #f0f0f0;
      }
    </style>
  </head>
  <body>
    <h1>Электроникийн Хайлтын Систем</h1>

    <!-- Хайлтын Форм -->
    <div class="search-container">
      <label for="searchInput">Хайлт:</label>
      <div style="position: relative">
        <input
          type="text"
          id="searchInput"
          placeholder="Бүтээгдэхүүн хайх..."
        />
        <div id="suggestions"></div>
      </div>

      <label for="categoryFilter">Ангилал:</label>
      <select id="categoryFilter">
        <option value="">Бүгд</option>
        <option value="All Beauty">Бүх Гоо Сайхан</option>
        <option value="All Electronics">Бүх Электроник</option>
        <option value="Amazon Devices">Amazon Төхөөрөмжүүд</option>
        <option value="AMAZON FASHION">Amazon Загвар</option>
        <option value="Amazon Fire TV">Amazon Fire TV</option>
        <option value="Amazon Home">Amazon Гэр</option>
        <option value="Apple Products">Apple-ийн Бүтээгдэхүүнүүд</option>
        <option value="Appliances">Гэр Ахуйн Хэрэгсэл</option>
        <option value="Arts, Crafts & Sewing">Урлаг, Гар Урлал ба Оёдол</option>
        <option value="Audible Audiobooks">Audible Аудио Ном</option>
        <option value="Automotive">Автомашин</option>
        <option value="Baby">Хүүхдийн</option>
        <option value="Books">Ном</option>
        <option value="Buy a Kindle">Kindle Худалдаж Авах</option>
        <option value="Camera & Photo">Камер ба Зураг</option>
        <option value="Car Electronics">Машины Электроник</option>
        <option value="Cell Phones & Accessories">
          Утас ба Дагалдах Хэрэгсэл
        </option>
        <option value="Collectible Coins">Цуглуулгын Зоос</option>
        <option value="Collectibles & Fine Art">
          Цуглуулга ба Дүрслэх Урлаг
        </option>
        <option value="Computers">Компьютер</option>
        <option value="Digital Music">Дижитал Хөгжим</option>
        <option value="Fire Phone">Fire Утас</option>
        <option value="Gift Cards">Бэлгийн Карт</option>
        <option value="GPS & Navigation">GPS ба Навигац</option>
        <option value="Grocery">Хүнс</option>
        <option value="Handmade">Гар хийцийн</option>
        <option value="Health & Personal Care">
          Эрүүл Мэнд ба Хувийн Ариун Цэвэр
        </option>
        <option value="Home Audio & Theater">Гэрийн Аудио ба Театр</option>
        <option value="Industrial & Scientific">
          Үйлдвэр ба Шинжлэх Ухаан
        </option>
        <option value="Magazine Subscriptions">Сэтгүүлийн Захиалга</option>
        <option value="Movies & TV">Кино ба ТВ</option>
        <option value="Musical Instruments">Хөгжмийн Зэмсэг</option>
        <option value="None">Ангилалгүй</option>
        <option value="Office Products">Оффисын Бүтээгдэхүүн</option>
        <option value="Pet Supplies">Тэжээвэр Амьтны Хэрэгсэл</option>
        <option value="Portable Audio & Accessories">
          Зөөврийн Аудио ба Дагалдах Хэрэгсэл
        </option>
        <option value="Premium Beauty">Дээд Зэрэглэлийн Гоо Сайхан</option>
        <option value="Software">Программ Хангамж</option>
        <option value="Sports & Outdoors">Спорт ба Гадна</option>
        <option value="Tools & Home Improvement">
          Багаж ба Гэрийн Сайжруулалт
        </option>
        <option value="Toys & Games">Тоглоом ба Наадгай</option>
        <option value="Unique Finds">Онцгой Олдворууд</option>
        <option value="Video Games">Видео Тоглоом</option>
      </select>

      <label for="minRating">Хамгийн бага үнэлгээ:</label>
      <input
        type="number"
        id="minRating"
        min="0"
        max="5"
        step="0.1"
        placeholder="4.0"
      />

      <label for="minReviews">Хамгийн бага сэтгэгдлийн тоо:</label>
      <input type="number" id="minReviews" min="0" placeholder="100" />

      <label for="sortBy">Эрэмбэлэх:</label>
      <select id="sortBy">
        <option value="rating_desc">Үнэлгээ (буурах)</option>
        <option value="price_asc">Үнэ (өсөх)</option>
        <option value="price_desc">Үнэ (буурах)</option>
      </select>

      <button onclick="search()">Хайх</button>
    </div>

    <!-- Хайлтын Илэрцүүд -->
    <div id="results"></div>

    <!-- Хуудасны Логик -->
    <div class="pagination">
      <button onclick="previousPage()" id="prevButton">Өмнөх</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()" id="nextButton">Дараах</button>
    </div>

    <!-- Аналитик -->
    <div class="analytics-container">
      <h2>Хайлтын Аналитик</h2>
      <button onclick="fetchAnalytics()">Аналитикийг Харуулах</button>
      <div id="analytics"></div>
    </div>

    <!-- Санал Хүсэлт -->
    <div class="feedback-container">
      <h2>Санал Хүсэлт</h2>
      <textarea
        id="feedbackInput"
        placeholder="Таны санал хүсэлтийг энд бичнэ үү..."
      ></textarea>
      <button onclick="submitFeedback()">Илгээх</button>
      <button onclick="fetchFeedback()" style="margin-left: 10px">
        Санал Хүсэлтүүдийг Харуулах
      </button>
      <div id="feedbackList"></div>
    </div>

    <script>
      let currentPage = 1;
      let totalPages = 1;

      // Хайлт хийх функц
      async function search() {
        const query = document.getElementById("searchInput").value;
        const category = document.getElementById("categoryFilter").value || "";
        const minRating = document.getElementById("minRating").value || "";
        const minReviews = document.getElementById("minReviews").value || "";
        const sortBy = document.getElementById("sortBy").value || "rating_desc";

        const url = new URL("http://127.0.0.1:5000/products");
        url.searchParams.append("query", query);
        if (category) url.searchParams.append("category", category);
        if (minRating) url.searchParams.append("min_rating", minRating);
        if (minReviews) url.searchParams.append("min_reviews", minReviews);
        url.searchParams.append("sort_by", sortBy);
        url.searchParams.append("page", currentPage);
        url.searchParams.append("limit", 10);

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          displayResults(data);
        } catch (error) {
          console.error("Хайлтын алдаа:", error);
          document.getElementById(
            "results"
          ).innerHTML = `<p style="color: red;">Алдаа гарлаа: ${error.message}</p>`;
        }
      }

      // Илэрцүүдийг харуулах функц
      function displayResults(data) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = "";

        if (data.results.length === 0) {
          resultsDiv.innerHTML = "<p>Илэрц олдсонгүй.</p>";
          return;
        }

        data.results.forEach((item) => {
          const resultItem = document.createElement("div");
          resultItem.className = "result-item";
          resultItem.innerHTML = `
                    <h3>${item.product_name}</h3>
                    <p><strong>Ангилал:</strong> ${item.main_category}</p>
                    <p><strong>Үнэ:</strong> $${
                      item.price !== null ? item.price.toFixed(2) : "N/A"
                    }</p>
                    <p><strong>Дундаж Үнэлгээ:</strong> ${
                      item.average_rating !== null
                        ? item.average_rating.toFixed(1)
                        : "N/A"
                    }</p>
                    <p><strong>Сэтгэгдлийн Тоо:</strong> ${
                      item.rating_number || 0
                    }</p>
                `;
          resultsDiv.appendChild(resultItem);
        });

        // Хуудасны мэдээлэл
        totalPages = data.metadata.total_pages;
        document.getElementById(
          "pageInfo"
        ).textContent = `Хуудас ${data.metadata.page}/${totalPages}`;
        document.getElementById("prevButton").disabled = currentPage === 1;
        document.getElementById("nextButton").disabled =
          currentPage === totalPages;
      }

      // Хуудасны логик
      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          search();
        }
      }

      function nextPage() {
        if (currentPage < totalPages) {
          currentPage++;
          search();
        }
      }

      // Автоматаар бөглөх (Autocomplete)
      document
        .getElementById("searchInput")
        .addEventListener("input", async function () {
          const query = this.value;
          if (!query) {
            document.getElementById("suggestions").style.display = "none";
            return;
          }

          const response = await fetch(
            `http://127.0.0.1:5000/autocomplete?query=${encodeURIComponent(
              query
            )}`
          );
          const suggestions = await response.json();

          const suggestionsDiv = document.getElementById("suggestions");
          suggestionsDiv.innerHTML = "";
          if (suggestions.length > 0) {
            suggestions.forEach((suggestion) => {
              const div = document.createElement("div");
              div.textContent = suggestion;
              div.addEventListener("click", () => {
                document.getElementById("searchInput").value = suggestion;
                suggestionsDiv.style.display = "none";
                search();
              });
              suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.style.display = "block";
          } else {
            suggestionsDiv.style.display = "none";
          }
        });

      // Автоматаар бөглөх хэсгийг хаах
      document.addEventListener("click", (e) => {
        if (
          !e.target.closest("#searchInput") &&
          !e.target.closest("#suggestions")
        ) {
          document.getElementById("suggestions").style.display = "none";
        }
      });

      // Аналитикыг харуулах
      async function fetchAnalytics() {
        const response = await fetch("http://127.0.0.1:5000/analytics");
        const data = await response.json();

        const analyticsDiv = document.getElementById("analytics");
        analyticsDiv.innerHTML = "<h3>Топ 10 Хайлтын Статистик</h3>";
        data.forEach((stat) => {
          analyticsDiv.innerHTML += `
                    <p><strong>Хайлтын текст:</strong> ${stat.query}<br>
                    <strong>Ангилал:</strong> ${
                      stat.main_category || "Бүгд"
                    }<br>
                    <strong>Хайлтын тоо:</strong> ${stat.search_count}<br>
                    <strong>Дундаж хугацаа:</strong> ${stat.avg_duration.toFixed(
                      3
                    )} секунд<br>
                    <strong>Дундаж илэрцийн тоо:</strong> ${stat.avg_result_count.toFixed(
                      1
                    )}</p>
                `;
        });
      }

      // Санал хүсэлт илгээх
      async function submitFeedback() {
        const feedback = document.getElementById("feedbackInput").value;
        if (!feedback) {
          alert("Санал хүсэлт оруулна уу!");
          return;
        }

        const response = await fetch("http://127.0.0.1:5000/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ feedback }),
        });

        const result = await response.json();
        alert(result.message || "Санал хүсэлт илгээгдлээ!");
        document.getElementById("feedbackInput").value = "";
      }

      // Санал хүсэлтүүдийг харуулах
      async function fetchFeedback() {
        const response = await fetch("http://127.0.0.1:5000/feedback");
        const data = await response.json();

        const feedbackList = document.getElementById("feedbackList");
        feedbackList.innerHTML = "<h3>Сүүлийн 50 Санал Хүсэлт</h3>";
        data.forEach((fb) => {
          const div = document.createElement("div");
          div.className = "feedback-item";
          div.innerHTML = `<p><strong>Санал:</strong> ${fb.feedback_text}<br><strong>Огноо:</strong> ${fb.submitted_at}</p>`;
          feedbackList.appendChild(div);
        });
      }
    </script>
  </body>
</html>
